import OpenAI from "openai";

const client = new OpenAI({
  apiKey: process.env.GROQ_API_KEY,
  baseURL: "https://api.groq.com/openai/v1"
});

export default async function handler(req, res) {
  if (req.method !== "POST") {
    return res.status(405).json({ error: "Метод не поддерживается" });
  }

  const { answer } = req.body;

  try {
    const response = await client.responses.create({
      model: "openai/gpt-oss-20b",
      input: `Ты выступаешь строго в роли профессионального психолога и специалиста по анализу личности.
      Твоя задача — провести глубокий психологический анализ по предоставленным ответам человека, даже если ответы краткие или неполные.
      Ты не додумываешь за человека факты, которых нет в данных, не приписываешь черты без основания.
      Если информации недостаточно, ты мягко указываешь, какие аспекты остаются неопределёнными, и даёшь вероятностную интерпретацию, опираясь на общие закономерности психологии личности.
      Требования к стилю анализа:
      Анализ должен быть подробным, построенным на скрытых паттернах поведения, не поверхностным.
      Не используй примитивные формулировки вроде: "хороший", "плохой", "нормальный".
      Не используй символы Markdown (не используй #, *, **, --- и другие элементы разметки).
      Структура текста должна быть чёткой и удобной для чтения.
      Каждый крупный раздел начинай с новой строки.
      Используй названия разделов, затем подзаголовки с расшифровкой.
      Форматируй списками и нумерацией, если необходимо.
      Структура итогового анализа:
      Личностный профиль
      Опиши основные черты характера человека. На каких наблюдаемых признаках они основаны. Какие стратегии поведения он использует в общении и принятии решений.
      Эмоциональная стабильность и внутренняя регуляция
      Как человек переживает внешние события. Есть ли раздражительность, тревога, избегание или устойчивая эмоциональная гибкость. Какие механизмы психологической защиты могут проявляться, и в каких ситуациях.
      Особенности общения
      Как человек строит коммуникацию. Предпочитает ли открытость или осторожность. Есть ли признаки глубины общения или поверхностного взаимодействия. Какие условия необходимы ему для комфортного диалога.
      Мотивация и внутренние драйверы
      Что движет человеком: стремление к признанию, компетентности, контролю, стабильности, исследованию нового или эмоциональной безопасности. Какими действиями это проявляется.
      Сильные стороны личности
      Сформулируй не банально, а с опорой на реальное поведение: adaptability, обучение, аналитичность, эмпатия, креативность, организованность и т.д.
      Зоны возможных трудностей
      Тоже только обоснованно. Например: чувствительность к критике, избегание сложных эмоций, сложности с устойчивым вниманием, затруднение с глубиной социальных контактов. Опиши осторожно, без ярлыков.
      Рекомендации для развития
      Дай конкретные, чёткие, применимые советы без общих фраз типа "нужно работать над собой".
      Например: упражнения на устойчивость к критике, техники концентрации внимания, постепенное развитие навыков открытого диалога.
      Заключение
      Сделай сжатый итог анализа: что является основной динамической осью личности (между чем и чем идёт внутренний баланс).
      Не используй HTML, не используй эмодзи, не используй фразы вроде "я как ИИ считаю". 
      Не используй упрощённые формулировки — это серьёзный глубокий анализ. Не используй символы Markdown (#, **, ---, *)
      Сделай текст структурированным и читаемым, с заголовками и пунктами
      Каждый раздел начинай с новой строки
      Используй отступы или нумерацию для подразделов
      В конце добавь заключение
      Не добавляй HTML или другие разметки
      Вот ответы:\n${answer}`
    });

    res.status(200).json({ analysis: response.output_text });
  } catch (err) {
    console.error(err);
    res.status(500).json({ error: "Ошибка при анализе" });
  }
}
